
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="others" />
        <meta name="keywords" content="Docker" />
        <meta name="description" content="在 Docker基础技术：Linux Namespace（上篇)中我们了解了，UTD、IPC、PID、Mount 四个namespace，我们模仿Docker做了一个相当相当山寨的镜像。在这一篇中，主要想向大家介绍Linux的User和Network的Namespace。 好，下面我们就介绍一下还剩下的这两个Namespace。 User Namespace User Namespace 主要是用了CLONE_NEWUSER的参数。使用了这个参数后，内部看到的UID和GID已经与外部不同了，默认显示为65534。那是因为容器找不到其真正的UID所以，设置上了最大的UID（其设置定义在/proc/sys/kernel/overflowuid）。 要把容器中的uid和真实系统的uid给映射在一起，需要修改 /proc//uid_map 和 /proc//gid_map 这两个文件。这两个文件的格式为： ID-inside-ns ID-outside-ns length 其中： 第一个字段ID-inside-ns表示在容器显示的UID或GID， 第二个字段ID-outside-ns表示容器外映射的真实的UID或GID。 第三个字段表示映射的范围，一般填1，表示一一对应。 比如 ..." />

<!-- Open Graph tags -->
<meta property="og:site_name" content="路漫求索"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Docker基础技术：Linux Namespace（下）"/>
    <meta property="og:url" content="../../../../2016/08/12/Docker/"/>
    <meta property="og:description" content="在 Docker基础技术：Linux Namespace（上篇)中我们了解了，UTD、IPC、PID、Mount 四个namespace，我们模仿Docker做了一个相当相当山寨的镜像。在这一篇中，主要想向大家介绍Linux的User和Network的Namespace。 好，下面我们就介绍一下还剩下的这两个Namespace。 User Namespace User Namespace 主要是用了CLONE_NEWUSER的参数。使用了这个参数后，内部看到的UID和GID已经与外部不同了，默认显示为65534。那是因为容器找不到其真正的UID所以，设置上了最大的UID（其设置定义在/proc/sys/kernel/overflowuid）。 要把容器中的uid和真实系统的uid给映射在一起，需要修改 /proc//uid_map 和 /proc//gid_map 这两个文件。这两个文件的格式为： ID-inside-ns ID-outside-ns length 其中： 第一个字段ID-inside-ns表示在容器显示的UID或GID， 第二个字段ID-outside-ns表示容器外映射的真实的UID或GID。 第三个字段表示映射的范围，一般填1，表示一一对应。 比如 ..."/>
    <meta property="article:published_time" content="2016-08-12" />
    <meta property="article:section" content="Docker专题" />
        <meta property="article:tag" content="Docker" />
        <meta property="article:author" content="others" />
        <meta property="og:image"
              content="../../../../favicon.png"/>

    <title>Docker基础技术：Linux Namespace（下） - 路漫求索</title>

        <link rel="stylesheet" href="../../../../theme/css/bootstrap.sandstone.min.css" type="text/css"/>

    <link href="../../../../theme/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../../../theme/css/pygments/colorful.css" rel="stylesheet" />
    
    <link href="../../../../theme/css/pelican-twitchy.min.css" rel="stylesheet" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <!-- Feeds -->
        <link href="../../../../feeds/atom.xml" type="application/atom+xml" rel="alternate"
              title="路漫求索 ATOM Feed" />
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="../../../.." title="路漫求索" class="collapsed">
            <span class="glyphicon glyphicon-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="../../../../archives.html" title="最新文章" class="collapsed">
            <span class="glyphicon glyphicon-th-list"></span>
        </a>
    </li>
                
                <li class="nav-divider"></li>
                <li id="share-small">
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-share-small" title="分享" class="collapsed">
                        <i class="fa fa-share-alt padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-share-small" class="collapse ">
                    <li>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=../../../../2016/08/12/Docker/" title="Share via Facebook" target="popup">
                            <i class="fa fa-facebook-square padding-small"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/share?url=../../../../2016/08/12/Docker/" title="Share via Google+" target="popup">
                            <i class="fa fa-google-plus padding-small"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" title="Share via Twitter" target="popup">
                            <i class="fa fa-twitter-square padding-small"></i>
                        </a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-social-small" title="Social" class="collapsed">
                        <i class="fa fa-users padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social-small" class="collapse ">
                    <li>
                        <a href="mailto:peng.li@i-soft.com.cn" title="EMAIL"><i class="fa fa-envelope-square fa-lg padding-small"></i></a>
                    </li>
                    <li>
                        <a href="https://github.com/king32783784" title="GitHub"><i class="fa fa-github-square fa-lg padding-small"></i></a>
                    </li>
                    <li>
                        <a href="http://king32783784.github.io/feeds/atom.xml" title="RSS"><i class="fa fa-rss-square fa-lg padding-small"></i></a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fa fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </div>
        <div id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="../../../../">
<img src="../../../../sitelogo.png" width="200" alt="Sitelogo"/>                     </a>
                </li>
                    <li class="nav-divider"></li>
                    <li>
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse-latest">
                            <span class="glyphicon glyphicon-th-list padding-small"></span>
                            最新文章
                        </a>
                    </li>
                    <li class="panel anti-panel"><ul id="collapse-latest" class="sidebar_submenu collapse in">
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/08/19/Multue/" title="Multue测试工具介绍">
                                <i class="fa fa-file-text padding-small"></i>
                                Multue测试工具介绍
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/06/17/网络/" title="网络速率统计的几个示例">
                                <i class="fa fa-file-text padding-small"></i>
                                网络速率统计的几个示例
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/04/01/Robot/" title="Robot Framework 用户手册(三)">
                                <i class="fa fa-file-text padding-small"></i>
                                Robot Framework 用户手册(三)
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/03/31/Robot/" title="Robot Framework 用户手册(二)">
                                <i class="fa fa-file-text padding-small"></i>
                                Robot Framework 用户手册(二)
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/03/26/Robot/" title="Robot Framework 用户手册(一)">
                                <i class="fa fa-file-text padding-small"></i>
                                Robot Framework 用户手册(一)
                            </a>
                        </li>
                    <li>
                        <a href="../../../../archives.html">
                            <i class="fa fa-arrow-right padding-small"></i>
                            更多
                        </a>
                    </li>
                    </ul></li>
                <li class="nav-divider"></li>
                <li id="share">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-share" title="Share" class="collapsed">
                        <i class="fa fa-share-alt padding-small"></i>
                        分享
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-share" class="sidebar_submenu collapse ">
                    <li>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=../../../../2016/08/12/Docker/" target="popup">
                            <i class="fa fa-facebook-square padding-small"></i>
                            Facebook
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/share?url=../../../../2016/08/12/Docker/" target="popup">
                            <i class="fa fa-google-plus padding-small"></i>
                            Google+
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" target="popup">
                            <i class="fa fa-twitter-square padding-small"></i>
                            Twitter
                        </a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-social">
                        <i class="fa fa-users padding-small"></i>
                        联系
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social" class="sidebar_submenu collapse ">
                    <li>
                        <a href="mailto:peng.li@i-soft.com.cn" title="EMAIL">
                            <i class="fa fa-envelope-square fa-lg padding-small"></i>
                            EMAIL
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/king32783784" title="GitHub">
                            <i class="fa fa-github-square fa-lg padding-small"></i>
                            GitHub
                        </a>
                    </li>
                    <li>
                        <a href="http://king32783784.github.io/feeds/atom.xml" title="RSS">
                            <i class="fa fa-rss-square fa-lg padding-small"></i>
                            RSS
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-pages">
                        <i class="fa fa-folder-open padding-small"></i>
                       站内导航
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-pages" class="sidebar_submenu collapse ">
                    <li>
                        <a href="../../../../pages/opensource.html">
                            <i class="fa fa-file-text padding-small"></i>
                            开源项目
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/links.html">
                            <i class="fa fa-file-text padding-small"></i>
                            常用链接
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/Reference material.html">
                            <i class="fa fa-file-text padding-small"></i>
                            参考资料
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/todo list.html">
                            <i class="fa fa-file-text padding-small"></i>
                            Todo List
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/tools.html">
                            <i class="fa fa-file-text padding-small"></i>
                            工具集
                        </a>
                    </li>
                    <li class="active">
                        <a href="../../../../pages/aboutme.html">
                            <i class="fa fa-file-text padding-small"></i>
                            关于我
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/doc.html">
                            <i class="fa fa-file-text padding-small"></i>
                            专题文档
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fa fa-folder-open padding-small"></i>
                        文章分类
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li >
                        <a href="../../../../category/bian-cheng-yu-yan-python.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            编程语言-Python
                            <span class="badge pull-right categorybadge">26</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-selenium.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-Selenium
                            <span class="badge pull-right categorybadge">17</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-autotest.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-Autotest
                            <span class="badge pull-right categorybadge">12</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-ltp.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-LTP
                            <span class="badge pull-right categorybadge">7</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/linux.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Linux
                            <span class="badge pull-right categorybadge">6</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/ce-shi.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            测试
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/leetcode.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            leetcode
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/qi-ta.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            其他
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/xing-neng-ce-shi.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            性能测试
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-robot.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-Robot
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/bian-cheng-yu-yan-c.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            编程语言-C
                            <span class="badge pull-right categorybadge">3</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="../../../../category/dockerzhuan-ti.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Docker专题
                            <span class="badge pull-right categorybadge">3</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/python-pyqt.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Python-pyqt
                            <span class="badge pull-right categorybadge">3</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-avocado.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-Avocado
                            <span class="badge pull-right categorybadge">3</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/suan-fa.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            算法
                            <span class="badge pull-right categorybadge">2</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/unixhuan-jing-bian-cheng.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            unix环境编程
                            <span class="badge pull-right categorybadge">2</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-gong-ju.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试工具
                            <span class="badge pull-right categorybadge">2</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/gong-ju.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            工具
                            <span class="badge pull-right categorybadge">1</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/mongodb.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Mongodb
                            <span class="badge pull-right categorybadge">1</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/tong-xin-xiang-guan.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            通信相关
                            <span class="badge pull-right categorybadge">1</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/web.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Web
                            <span class="badge pull-right categorybadge">1</span>
                        </a>
                    </li>
                </ul></li>
                
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <a href="#menu-toggle" class="btn btn-default" id="menu-toggle">
            <span id="right-arrow" class="glyphicon glyphicon-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="glyphicon glyphicon-chevron-left" title="minimize sidebar"></span>
        </a>
       <!-- /open/close sidebar -->
       <!--访问统计 -->
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-9">
                <header class="page-header">
                    <h1>
                        <a href="../../../../2016/08/12/Docker/"
                           rel="bookmark"
                           title="Permalink to Docker基础技术：Linux Namespace（下）">
                            Docker基础技术：Linux Namespace（下）<转>
                        </a>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2016-08-12T00:00:00+08:00"> 2016-08-12 五</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="../../../../category/dockerzhuan-ti.html">Docker专题</a>
            </span>
            <span class="tags">
                <i class="fa fa-tags padding-small"></i>
                <a href="../../../../tag/docker.html">Docker</a>            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-9">
                <div class="entry-content">
                    <body><p>在 <a href="https://king32783784.github.io/lipeng/2016/08/11/Docker/">Docker基础技术：Linux Namespace（上篇)</a>中我们了解了，UTD、IPC、PID、Mount 四个namespace，我们模仿Docker做了一个相当相当山寨的镜像。在这一篇中，主要想向大家介绍Linux的User和Network的Namespace。</p>
<p>好，下面我们就介绍一下还剩下的这两个Namespace。</p>
<h4 id="user-namespace">User Namespace</h4>
<p><strong>User Namespace</strong> 主要是用了CLONE_NEWUSER的参数。使用了这个参数后，内部看到的UID和GID已经与外部不同了，默认显示为65534。那是因为容器找不到其真正的UID所以，设置上了最大的UID（其设置定义在/proc/sys/kernel/overflowuid）。</p>
<p>要把容器中的uid和真实系统的uid给映射在一起，需要修改 <strong>/proc/<pid>/uid_map</pid></strong>  和 <strong>/proc/<pid>/gid_map</pid></strong> 这两个文件。这两个文件的格式为：</p>
<p>ID-inside-ns ID-outside-ns length</p>
<p>其中：</p>
<ul>
<li>第一个字段ID-inside-ns表示在容器显示的UID或GID，</li>
<li>第二个字段ID-outside-ns表示容器外映射的真实的UID或GID。</li>
<li>第三个字段表示映射的范围，一般填1，表示一一对应。</li>
</ul>
<p>比如，把真实的uid=1000映射成容器内的uid=0</p>
<div class="highlight"><pre><span></span>$ cat /proc/2465/uid_map
     <span class="m">0</span>       <span class="m">1000</span>          <span class="m">1</span>
</pre></div>
<p>再比如下面的示例：表示把namespace内部从0开始的uid映射到外部从0开始的uid，其最大范围是无符号32位整形</p>
<div class="highlight"><pre><span></span>$ cat /proc/<span class="nv">$$</span>/uid_map
     <span class="m">0</span>          <span class="m">0</span>          <span class="m">4294967295</span>
</pre></div>
<p>另外，需要注意的是：</p>
<ul>
<li>写这两个文件的进程需要这个namespace中的CAP_SETUID (CAP_SETGID)权限（可参看Capabilities）</li>
<li>写入的进程必须是此user namespace的父或子的user namespace进程。</li>
<li>另外需要满如下条件之一：1）父进程将effective uid/gid映射到子进程的user namespace中，2）父进程如果有CAP_SETUID/CAP_SETGID权限，那么它将可以映射到父进程中的任一uid/gid。</li>
<li>这些规则看着都烦，我们来看程序吧（下面的程序有点长，但是非常简单，如果你读过《Unix网络编程》上卷，你应该可以看懂):</li>
</ul>
<p>code:</p>
<div class="highlight"><pre><span></span><span class="cp">#define _GNU_SOURCE</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/mount.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/capability.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sched.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="cp">#define STACK_SIZE (1024 * 1024)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">container_stack</span><span class="p">[</span><span class="n">STACK_SIZE</span><span class="p">];</span>
<span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">container_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"/bin/bash"</span><span class="p">,</span>
    <span class="nb">NULL</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">pipefd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">set_map</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inside_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">outside_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">FILE</span><span class="o">*</span> <span class="n">mapfd</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s">"w"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">mapfd</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"open file error"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">mapfd</span><span class="p">,</span> <span class="s">"%d %d %d"</span><span class="p">,</span> <span class="n">inside_id</span><span class="p">,</span> <span class="n">outside_id</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">mapfd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_uid_map</span><span class="p">(</span><span class="kt">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inside_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">outside_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">file</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s">"/proc/%d/uid_map"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
    <span class="n">set_map</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">inside_id</span><span class="p">,</span> <span class="n">outside_id</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_gid_map</span><span class="p">(</span><span class="kt">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inside_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">outside_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">file</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s">"/proc/%d/gid_map"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
    <span class="n">set_map</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">inside_id</span><span class="p">,</span> <span class="n">outside_id</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">container_main</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Container [%5d] - inside the container!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Container: eUID = %ld;  eGID = %ld, UID=%ld, GID=%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">geteuid</span><span class="p">(),</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">getegid</span><span class="p">(),</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">getuid</span><span class="p">(),</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">getgid</span><span class="p">());</span>

    <span class="cm">/* 等待父进程通知后再往下执行（进程间的同步） */</span>
    <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
    <span class="n">close</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Container [%5d] - setup hostname!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="c1">//set hostname</span>
    <span class="n">sethostname</span><span class="p">(</span><span class="s">"container"</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>

    <span class="c1">//remount "/proc" to make sure the "top" and "ps" show container's information</span>
    <span class="n">mount</span><span class="p">(</span><span class="s">"proc"</span><span class="p">,</span> <span class="s">"/proc"</span><span class="p">,</span> <span class="s">"proc"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">execv</span><span class="p">(</span><span class="n">container_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">container_args</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Something's wrong!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">=</span><span class="n">getgid</span><span class="p">(),</span> <span class="n">uid</span><span class="o">=</span><span class="n">getuid</span><span class="p">();</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Parent: eUID = %ld;  eGID = %ld, UID=%ld, GID=%ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">geteuid</span><span class="p">(),</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">getegid</span><span class="p">(),</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">getuid</span><span class="p">(),</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">getgid</span><span class="p">());</span>

    <span class="n">pipe</span><span class="p">(</span><span class="n">pipefd</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Parent [%5d] - start a container!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>

    <span class="kt">int</span> <span class="n">container_pid</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">container_main</span><span class="p">,</span> <span class="n">container_stack</span><span class="o">+</span><span class="n">STACK_SIZE</span><span class="p">,</span>
            <span class="n">CLONE_NEWUTS</span> <span class="o">|</span> <span class="n">CLONE_NEWPID</span> <span class="o">|</span> <span class="n">CLONE_NEWNS</span> <span class="o">|</span> <span class="n">CLONE_NEWUSER</span> <span class="o">|</span> <span class="n">SIGCHLD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


    <span class="n">printf</span><span class="p">(</span><span class="s">"Parent [%5d] - Container [%5d]!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">container_pid</span><span class="p">);</span>

    <span class="c1">//To map the uid/gid,</span>
   <span class="c1">//   we need edit the /proc/PID/uid_map (or /proc/PID/gid_map) in parent</span>
    <span class="c1">//The file format is</span>
    <span class="c1">//   ID-inside-ns   ID-outside-ns   length</span>
    <span class="c1">//if no mapping,</span>
    <span class="c1">//   the uid will be taken from /proc/sys/kernel/overflowuid</span>
    <span class="c1">//   the gid will be taken from /proc/sys/kernel/overflowgid</span>
    <span class="n">set_uid_map</span><span class="p">(</span><span class="n">container_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">set_gid_map</span><span class="p">(</span><span class="n">container_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Parent [%5d] - user/group mapping done!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>

    <span class="cm">/* 通知子进程 */</span>
    <span class="n">close</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="n">waitpid</span><span class="p">(</span><span class="n">container_pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Parent - container stopped!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>上面的程序，我们用了一个pipe来对父子进程进行同步，为什么要这样做？因为子进程中有一个execv的系统调用，这个系统调用会把当前子进程的进程空间给全部覆盖掉，我们希望在execv之前就做好user namespace的uid/gid的映射，这样，execv运行的/bin/bash就会因为我们设置了uid为0的inside-uid而变成#号的提示符。</p>
<p>整个程序的运行效果如下：</p>
<div class="highlight"><pre><span></span><span class="nt">hchen</span><span class="p">@</span><span class="k">ubuntu</span><span class="o">:~$</span> <span class="nt">id</span>
<span class="nt">uid</span><span class="o">=</span><span class="nt">1000</span><span class="o">(</span><span class="nt">hchen</span><span class="o">)</span> <span class="nt">gid</span><span class="o">=</span><span class="nt">1000</span><span class="o">(</span><span class="nt">hchen</span><span class="o">)</span> <span class="nt">groups</span><span class="o">=</span><span class="nt">1000</span><span class="o">(</span><span class="nt">hchen</span><span class="o">)</span>
<span class="nt">hchen</span><span class="p">@</span><span class="k">ubuntu</span><span class="o">:~$</span> <span class="o">./</span><span class="nt">user</span> <span class="err">#</span><span class="o">&lt;</span><span class="nt">--</span><span class="err">以</span><span class="nt">hchen</span><span class="err">用户运行</span>
<span class="nt">Parent</span><span class="o">:</span> <span class="nt">eUID</span> <span class="o">=</span> <span class="nt">1000</span><span class="p">;</span>  <span class="nt">eGID</span> <span class="o">=</span> <span class="nt">1000</span><span class="o">,</span> <span class="nt">UID</span><span class="o">=</span><span class="nt">1000</span><span class="o">,</span> <span class="nt">GID</span><span class="o">=</span><span class="nt">1000</span>
<span class="nt">Parent</span> <span class="cp">[</span> <span class="mi">3262</span><span class="cp">]</span> <span class="nt">-</span> <span class="nt">start</span> <span class="nt">a</span> <span class="nt">container</span><span class="o">!</span>
<span class="nt">Parent</span> <span class="cp">[</span> <span class="mi">3262</span><span class="cp">]</span> <span class="nt">-</span> <span class="nt">Container</span> <span class="cp">[</span> <span class="mi">3263</span><span class="cp">]</span><span class="o">!</span>
<span class="nt">Parent</span> <span class="cp">[</span> <span class="mi">3262</span><span class="cp">]</span> <span class="nt">-</span> <span class="nt">user</span><span class="o">/</span><span class="nt">group</span> <span class="nt">mapping</span> <span class="nt">done</span><span class="o">!</span>
<span class="nt">Container</span> <span class="cp">[</span>    <span class="mi">1</span><span class="cp">]</span> <span class="nt">-</span> <span class="nt">inside</span> <span class="nt">the</span> <span class="nt">container</span><span class="o">!</span>
<span class="nt">Container</span><span class="o">:</span> <span class="nt">eUID</span> <span class="o">=</span> <span class="nt">0</span><span class="p">;</span>  <span class="nt">eGID</span> <span class="o">=</span> <span class="nt">0</span><span class="o">,</span> <span class="nt">UID</span><span class="o">=</span><span class="nt">0</span><span class="o">,</span> <span class="nt">GID</span><span class="o">=</span><span class="nt">0</span> <span class="err">#</span><span class="o">&lt;</span><span class="nt">---Container</span><span class="err">里的</span><span class="nt">UID</span><span class="o">/</span><span class="nt">GID</span><span class="err">都为</span><span class="nt">0</span><span class="err">了</span>
<span class="nt">Container</span> <span class="cp">[</span>    <span class="mi">1</span><span class="cp">]</span> <span class="nt">-</span> <span class="nt">setup</span> <span class="nt">hostname</span><span class="o">!</span>

<span class="nt">root</span><span class="p">@</span><span class="k">container</span><span class="o">:~</span><span class="err">#</span> <span class="nt">id</span> <span class="err">#</span><span class="o">&lt;</span><span class="nt">----</span><span class="err">我们可以看到容器里的用户和命令行提示符是</span><span class="nt">root</span><span class="err">用户了</span>
<span class="nt">uid</span><span class="o">=</span><span class="nt">0</span><span class="o">(</span><span class="nt">root</span><span class="o">)</span> <span class="nt">gid</span><span class="o">=</span><span class="nt">0</span><span class="o">(</span><span class="nt">root</span><span class="o">)</span> <span class="nt">groups</span><span class="o">=</span><span class="nt">0</span><span class="o">(</span><span class="nt">root</span><span class="o">),</span><span class="nt">65534</span><span class="o">(</span><span class="nt">nogroup</span><span class="o">)</span>
<span class="err">虽然容器里是</span><span class="nt">root</span><span class="err">，但其实这个容器的</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">bash</span><span class="err">进程是以一个普通用户</span><span class="nt">hchen</span><span class="err">来运行的。这样一来，我们容器的安全性会得到提高。</span>
</pre></div>
<p>我们注意到，User Namespace是以普通用户运行，但是别的Namespace需要root权限，那么，如果我要同时使用多个Namespace，该怎么办呢？一般来说，我们先用一般用户创建User Namespace，然后把这个一般用户映射成root，在容器内用root来创建其它的Namesapce。</p>
<h4 id="network-namespace">Network Namespace</h4>
<p>Network的Namespace比较啰嗦。在Linux下，我们一般用ip命令创建Network Namespace（Docker的源码中，它没有用ip命令，而是自己实现了ip命令内的一些功能——是用了Raw Socket发些“奇怪”的数据，呵呵）。这里，我还是用ip命令讲解一下。</p>
<p>首先，我们先看个图，下面这个图基本上就是Docker在宿主机上的网络示意图（其中的物理网卡并不准确，因为docker可能会运行在一个VM中，所以，这里所谓的“物理网卡”其实也就是一个有可以路由的IP的网卡）</p>
<p><img alt="" class="img-responsive" src="https://king32783784.github.io/lipeng/tmpfile/network.namespace.jpg"/></p>
<p>上图中，Docker使用了一个私有网段，172.40.1.0，docker还可能会使用10.0.0.0和192.168.0.0这两个私有网段，关键看你的路由表中是否配置了，如果没有配置，就会使用，如果你的路由表配置了所有私有网段，那么docker启动时就会出错了。</p>
<p>当你启动一个Docker容器后，你可以使用ip link show或ip addr show来查看当前宿主机的网络情况（我们可以看到有一个docker0，还有一个veth22a38e6的虚拟网卡——给容器用的）：</p>
<div class="highlight"><pre><span></span>hchen@ubuntu:~$ ip link show
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state ...
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc ...
    link/ether 00:0c:29:b7:67:7d brd ff:ff:ff:ff:ff:ff
3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 ...
    link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff
5: veth22a38e6: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc ...
    link/ether 8e:30:2a:ac:8c:d1 brd ff:ff:ff:ff:ff:ff
</pre></div>
<p>那么，要做成这个样子应该怎么办呢？我们来看一组命令：</p>
<div class="highlight"><pre><span></span>## 首先，我们先增加一个网桥lxcbr0，模仿docker0
brctl addbr lxcbr0
brctl stp lxcbr0 off
ifconfig lxcbr0 192.168.10.1/24 up #为网桥设置IP地址

## 接下来，我们要创建一个network namespace - ns1

# 增加一个namesapce 命令为 ns1 （使用ip netns add命令）
ip netns add ns1

# 激活namespace中的loopback，即127.0.0.1（使用ip netns exec ns1来操作ns1中的命令）
ip netns exec ns1   ip link set dev lo up

## 然后，我们需要增加一对虚拟网卡

# 增加一个pair虚拟网卡，注意其中的veth类型，其中一个网卡要按进容器中
ip link add veth-ns1 type veth peer name lxcbr0.1

# 把 veth-ns1 按到namespace ns1中，这样容器中就会有一个新的网卡了
ip link set veth-ns1 netns ns1

# 把容器里的 veth-ns1改名为 eth0 （容器外会冲突，容器内就不会了）
ip netns exec ns1  ip link set dev veth-ns1 name eth0

# 为容器中的网卡分配一个IP地址，并激活它
ip netns exec ns1 ifconfig eth0 192.168.10.11/24 up


# 上面我们把veth-ns1这个网卡按到了容器中，然后我们要把lxcbr0.1添加上网桥上
brctl addif lxcbr0 lxcbr0.1

# 为容器增加一个路由规则，让容器可以访问外面的网络
ip netns exec ns1     ip route add default via 192.168.10.1

# 在/etc/netns下创建network namespce名称为ns1的目录，
# 然后为这个namespace设置resolv.conf，这样，容器内就可以访问域名了
mkdir -p /etc/netns/ns1
echo "nameserver 8.8.8.8" &gt; /etc/netns/ns1/resolv.conf
</pre></div>
<p>上面基本上就是docker网络的原理了，只不过，</p>
<p>Docker的resolv.conf没有用这样的方式，而是用了上篇中的Mount Namesapce的那种方式
另外，docker是用进程的PID来做Network Namespace的名称的。
了解了这些后，你甚至可以为正在运行的docker容器增加一个新的网卡：</p>
<div class="highlight"><pre><span></span>ip link add peerA type veth peer name peerB
brctl addif docker0 peerA
ip link set peerA up
ip link set peerB netns <span class="cp">${</span><span class="n">container</span><span class="o">-</span><span class="n">pid</span><span class="cp">}</span>
ip netns exec <span class="cp">${</span><span class="n">container</span><span class="o">-</span><span class="n">pid</span><span class="cp">}</span> ip link set dev peerB name eth1
ip netns exec <span class="cp">${</span><span class="n">container</span><span class="o">-</span><span class="n">pid</span><span class="cp">}</span> ip link set eth1 up ;
ip netns exec <span class="cp">${</span><span class="n">container</span><span class="o">-</span><span class="n">pid</span><span class="cp">}</span> ip addr add <span class="cp">${</span><span class="n">ROUTEABLE_IP</span><span class="cp">}</span> dev eth1 ;
</pre></div>
<p>上面的示例是我们为正在运行的docker容器，增加一个eth1的网卡，并给了一个静态的可被外部访问到的IP地址。</p>
<p>这个需要把外部的“物理网卡”配置成混杂模式，这样这个eth1网卡就会向外通过ARP协议发送自己的Mac地址，然后外部的交换机就会把到这个IP地址的包转到“物理网卡”上，因为是混杂模式，所以eth1就能收到相关的数据，一看，是自己的，那么就收到。这样，Docker容器的网络就和外部通了。</p>
<p>当然，无论是Docker的NAT方式，还是混杂模式都会有性能上的问题，NAT不用说了，存在一个转发的开销，混杂模式呢，网卡上收到的负载都会完全交给所有的虚拟网卡上，于是就算一个网卡上没有数据，但也会被其它网卡上的数据所影响。</p>
<p>这两种方式都不够完美，我们知道，真正解决这种网络问题需要使用VLAN技术，于是Google的同学们为Linux内核实现了一个IPVLAN的驱动，这基本上就是为Docker量身定制的。</p>
<h4 id="namespacewen-jian">Namespace文件</h4>
<p>上面就是目前Linux Namespace的玩法。 现在，我来看一下其它的相关东西。</p>
<p>让我们运行一下上篇中的那个pid.mnt的程序（也就是PID Namespace中那个mount proc的程序），然后不要退出。</p>
<div class="highlight"><pre><span></span>$ sudo ./pid.mnt
<span class="o">[</span>sudo<span class="o">]</span> password <span class="k">for</span> hchen:
Parent <span class="o">[</span> <span class="m">4599</span><span class="o">]</span> - start a container!
Container <span class="o">[</span>    <span class="m">1</span><span class="o">]</span> - inside the container!
</pre></div>
<p>我们到另一个shell中查看一下父子进程的PID：</p>
<div class="highlight"><pre><span></span>hchen@ubuntu:~$ pstree -p 4599
pid.mnt(4599)───bash(4600)
</pre></div>
<p>我们可以到proc下（/proc//ns）查看进程的各个namespace的id（内核版本需要3.8以上）。</p>
<p>下面是父进程的：</p>
<div class="highlight"><pre><span></span>hchen@ubuntu:~$ sudo ls -l /proc/4599/ns
total 0
lrwxrwxrwx 1 root root 0  4月  7 22:01 ipc -&gt; ipc:[4026531839]
lrwxrwxrwx 1 root root 0  4月  7 22:01 mnt -&gt; mnt:[4026531840]
lrwxrwxrwx 1 root root 0  4月  7 22:01 net -&gt; net:[4026531956]
lrwxrwxrwx 1 root root 0  4月  7 22:01 pid -&gt; pid:[4026531836]
lrwxrwxrwx 1 root root 0  4月  7 22:01 user -&gt; user:[4026531837]
lrwxrwxrwx 1 root root 0  4月  7 22:01 uts -&gt; uts:[4026531838]
</pre></div>
<p>下面是子进程的：</p>
<div class="highlight"><pre><span></span>hchen@ubuntu:~$ sudo ls -l /proc/4600/ns
total 0
lrwxrwxrwx 1 root root 0  4月  7 22:01 ipc -&gt; ipc:[4026531839]
lrwxrwxrwx 1 root root 0  4月  7 22:01 mnt -&gt; mnt:[4026532520]
lrwxrwxrwx 1 root root 0  4月  7 22:01 net -&gt; net:[4026531956]
lrwxrwxrwx 1 root root 0  4月  7 22:01 pid -&gt; pid:[4026532522]
lrwxrwxrwx 1 root root 0  4月  7 22:01 user -&gt; user:[4026531837]
lrwxrwxrwx 1 root root 0  4月  7 22:01 uts -&gt; uts:[4026532521]
</pre></div>
<p>我们可以看到，其中的ipc，net，user是同一个ID，而mnt,pid,uts都是不一样的。如果两个进程指向的namespace编号相同，就说明他们在同一个namespace下，否则则在不同namespace里面。</p>
<p>这些文件还有另一个作用，那就是，一旦这些文件被打开，只要其fd被占用着，那么就算PID所属的所有进程都已经结束，创建的namespace也会一直存在。比如：我们可以通过：mount –bind /proc/4600/ns/uts ~/uts 来hold这个namespace。</p>
<p>另外，我们在上篇中讲过一个setns的系统调用，其函数声明如下：</p>
<div class="highlight"><pre><span></span>int setns(int fd, int nstype);
</pre></div>
<p>其中第一个参数就是一个fd，也就是一个open()系统调用打开了上述文件后返回的fd，比如：</p>
<div class="highlight"><pre><span></span>fd = open("/proc/4600/ns/nts", O_RDONLY);  // 获取namespace文件描述符
setns(fd, 0); // 加入新的namespace
</pre></div>
<p>参考文档</p>
<p><a href="http://lwn.net/Articles/531114/">Namespaces in operation</a></p>
<p><a href="http://man7.org/linux/man-pages/man7/namespaces.7.html">Linux Namespace Man Page</a></p>
<p><a href="http://crosbymichael.com/creating-containers-part-1.html">Creat Containers – Part 1</a></p>
<p><a href="https://blog.yadutaf.fr/2013/12/22/introduction-to-linux-namespaces-part-1-uts/">Introduction to Linux namespaces</a></p>
<p>（全文完）</p></body>
                </div>
                <footer class="text-right">
                    <p>by others</p>
                </footer>
  <!-- css -->
  <style type="text/css">
      .center {
          text-align: center;
      }
      .hidden {
          display: none;
      }
    .donate_bar a.btn_donate{
      display: inline-block;
      width: 80px;
      height:80px;
      background: url("http://7xsl28.com1.z0.glb.clouddn.com/btn_reward.gif") no-repeat;
      _background: url("http://7xsl28.com1.z0.glb.clouddn.com/btn_reward.gif") no-repeat;

      <!-- http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif
           因为本 hexo 生成的博客所用的 theme 的 a:hover 带动画效果，
         为了在让打赏按钮显示效果正常 而 添加了以下几行 css，
         嵌入其它博客时不一定要它们。 -->
      -webkit-transition: background 0s;
      -moz-transition: background 0s;
      -o-transition: background 0s;
      -ms-transition: background 0s;
      transition: background 0s;
      <!-- /让打赏按钮的效果显示正常 而 添加的几行 css 到此结束 -->
    }

    .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
    .donate_bar .donate_txt {
      display: block;
      color: #9d9d9d;
      font: 14px/2 "Microsoft Yahei";
    }
    .bold{ font-weight: bold; }
  </style>
  <!-- /css -->

    <!-- Donate Module -->
    <div id="donate_module">

  <!-- btn_donate & tips -->
  <div id="donate_board" class="donate_bar center">
      <br>
      ------------------------------------------------------------------------------------------------------------------------------
      <br>
    <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    <span class="donate_txt">
      <Enjoy it ? Donate me !  欣赏此文？求鼓励，求支持！>
    </span>
      
    
  </div>
  <!-- /btn_donate & tips -->

  <!-- donate guide -->
    
  <div id="donate_guide" class="donate_bar center hidden">
        <br>
      ------------------------------------------------------------------------------------------------------------------------------
      <br>

    <a href="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/wechart.png?raw=true" title="用微信扫一扫哦~" class="fancybox" rel="article0">
      <img src="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/wechart.png?raw=true" title="微信打赏 Colin" height="320px" width="auto"/>
    </a>
        
        &nbsp;&nbsp;
   <a href="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/alipay.png?raw=true" title="用支付宝扫一扫即可~" class="fancybox" rel="article0">
      <img src="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/alipay.png?raw=true" title="支付宝打赏 Colin" height="320px" width="auto"/>
    </a>

    <span class="donate_txt">
      <Enjoy it ? Donate me !  欣赏此文？求鼓励，求支持！>
    </span>

  </div>
  <!-- /donate guide -->

  <!-- donate script -->
  <script type="text/javascript">
    document.getElementById('btn_donate').onclick = function() {
      $('#donate_board').addClass('hidden');
      $('#donate_guide').removeClass('hidden');
    }

    function donate_on_web(){
      $('#donate').submit();
        }

    var original_window_onload = window.onload;
        window.onload = function () {
            if (original_window_onload) {
                original_window_onload();
            }
            document.getElementById('donate_board_wdg').className = 'hidden';
    }
  </script>
  <!-- /donate script -->
</div>
<!-- /Donate Module -->
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2127927"></script>
<!-- UY END -->
            </div>
    <div id="scrollspy">
        <div class="col-lg-3 nav nav-stacked hidden-xs hidden-sm" data-spy="affix" data-offset-top="135">
            <div id="toc"><ul><li><a class="toc-href" href="#" title="Docker基础技术：Linux Namespace（下）&lt;转&gt;">Docker基础技术：Linux Namespace（下）&lt;转&gt;</a><ul><li><a class="toc-href" href="#user-namespace" title="User Namespace">User Namespace</a></li><li><a class="toc-href" href="#network-namespace" title="Network Namespace">Network Namespace</a></li><li><a class="toc-href" href="#namespacewen-jian" title="Namespace文件">Namespace文件</a></li></ul></li></ul></div>
        </div>
    </div>
        </div>
    </article>
</section>

<!--"-->
<footer>
    <hr>
    <div class="row">
        <div class="col-lg-9 text-center">
            <p><small>
                <a href="http://www.reliablecounter.com" target="_blank"><img src="http://www.reliablecounter.com/count.php?page=https://king32783784.github.io/&digit=style/plain/6/&reloads=0" alt="" title="" border="0"></a><br /><a href="http://www.fabbly.com" target="_blank" style="font-family: Geneva, Arial; font-size: 9px; color: #330010; text-decoration: none;"></a>
                Copyright</a>  </a>
                <!--&middot;-->                    &copy;2009 李鹏
            </small></p>
        </div>
    </div>
</footer>
            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->
    <!-- jQuery Version 1.11.2 -->
    <script src="../../../../theme/js/jquery-1.11.2.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="../../../../theme/js/bootstrap.min.js"></script>
    <!-- twitchy Script -->
    <script src="../../../../theme/js/pelican_twitchy.min.js"></script>
    <!-- Begin Cookie Consent https://silktide.com/tools/cookie-consent/ -->
    <script>
        window.cookieconsent_options = {
            message: "This site uses Cookies. If you continue without changing your settings, it is assumed that you are happy to receive all cookies from this website.",
            learnMore: "More info",
            link: null,
            dismiss: "Got it!",
            theme: "../../../../theme/css/cookieconsent/dark-floating.css",
        };
    </script>
    <script src="../../../../theme/js/cookieconsent.min.js"></script>
    <!-- End Cookie Consent -->

</body>
</html>
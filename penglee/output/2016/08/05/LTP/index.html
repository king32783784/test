
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="李鹏" />
        <meta name="keywords" content="LTP" />
        <meta name="description" content="accept用例分析 case本身说明： Verify that accept() returns the proper errno for various failure cases 验证accept()是否返回正确的errno. 测试log accept01 1 TPASS : bad file descriptor successful accept01 2 TPASS : bad file descriptor successful accept01 3 TPASS : invalid socket buffer successful accept01 4 TPASS : invalid salen successful accept01 5 TPASS : invalid salen successful accept01 ..." />

<!-- Open Graph tags -->
<meta property="og:site_name" content="路漫求索"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="LTP－kernel-syscalls-accept()"/>
    <meta property="og:url" content="../../../../2016/08/05/LTP/"/>
    <meta property="og:description" content="accept用例分析 case本身说明： Verify that accept() returns the proper errno for various failure cases 验证accept()是否返回正确的errno. 测试log accept01 1 TPASS : bad file descriptor successful accept01 2 TPASS : bad file descriptor successful accept01 3 TPASS : invalid socket buffer successful accept01 4 TPASS : invalid salen successful accept01 5 TPASS : invalid salen successful accept01 ..."/>
    <meta property="article:published_time" content="2016-08-05" />
    <meta property="article:section" content="自动化测试-LTP" />
        <meta property="article:tag" content="LTP" />
        <meta property="article:author" content="李鹏" />
        <meta property="og:image"
              content="../../../../favicon.png"/>

    <title>LTP－kernel-syscalls-accept() - 路漫求索</title>

        <link rel="stylesheet" href="../../../../theme/css/bootstrap.sandstone.min.css" type="text/css"/>

    <link href="../../../../theme/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../../../theme/css/pygments/colorful.css" rel="stylesheet" />
    
    <link href="../../../../theme/css/pelican-twitchy.min.css" rel="stylesheet" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <!-- Feeds -->
        <link href="../../../../feeds/atom.xml" type="application/atom+xml" rel="alternate"
              title="路漫求索 ATOM Feed" />
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="../../../.." title="路漫求索" class="collapsed">
            <span class="glyphicon glyphicon-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="../../../../archives.html" title="最新文章" class="collapsed">
            <span class="glyphicon glyphicon-th-list"></span>
        </a>
    </li>
                
                <li class="nav-divider"></li>
                <li id="share-small">
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-share-small" title="分享" class="collapsed">
                        <i class="fa fa-share-alt padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-share-small" class="collapse ">
                    <li>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=../../../../2016/08/05/LTP/" title="Share via Facebook" target="popup">
                            <i class="fa fa-facebook-square padding-small"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/share?url=../../../../2016/08/05/LTP/" title="Share via Google+" target="popup">
                            <i class="fa fa-google-plus padding-small"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" title="Share via Twitter" target="popup">
                            <i class="fa fa-twitter-square padding-small"></i>
                        </a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-social-small" title="Social" class="collapsed">
                        <i class="fa fa-users padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social-small" class="collapse ">
                    <li>
                        <a href="mailto:peng.li@i-soft.com.cn" title="EMAIL"><i class="fa fa-envelope-square fa-lg padding-small"></i></a>
                    </li>
                    <li>
                        <a href="https://github.com/king32783784" title="GitHub"><i class="fa fa-github-square fa-lg padding-small"></i></a>
                    </li>
                    <li>
                        <a href="http://king32783784.github.io/feeds/atom.xml" title="RSS"><i class="fa fa-rss-square fa-lg padding-small"></i></a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fa fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </div>
        <div id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="../../../../">
<img src="../../../../sitelogo.png" width="200" alt="Sitelogo"/>                     </a>
                </li>
                    <li class="nav-divider"></li>
                    <li>
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse-latest">
                            <span class="glyphicon glyphicon-th-list padding-small"></span>
                            最新文章
                        </a>
                    </li>
                    <li class="panel anti-panel"><ul id="collapse-latest" class="sidebar_submenu collapse in">
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/08/19/Multue/" title="Multue测试工具介绍">
                                <i class="fa fa-file-text padding-small"></i>
                                Multue测试工具介绍
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/06/17/网络/" title="网络速率统计的几个示例">
                                <i class="fa fa-file-text padding-small"></i>
                                网络速率统计的几个示例
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/04/01/Robot/" title="Robot Framework 用户手册(三)">
                                <i class="fa fa-file-text padding-small"></i>
                                Robot Framework 用户手册(三)
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/03/31/Robot/" title="Robot Framework 用户手册(二)">
                                <i class="fa fa-file-text padding-small"></i>
                                Robot Framework 用户手册(二)
                            </a>
                        </li>
                        <li class="">
                            <a class="hide-overflow" href="../../../../2017/03/26/Robot/" title="Robot Framework 用户手册(一)">
                                <i class="fa fa-file-text padding-small"></i>
                                Robot Framework 用户手册(一)
                            </a>
                        </li>
                    <li>
                        <a href="../../../../archives.html">
                            <i class="fa fa-arrow-right padding-small"></i>
                            更多
                        </a>
                    </li>
                    </ul></li>
                <li class="nav-divider"></li>
                <li id="share">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-share" title="Share" class="collapsed">
                        <i class="fa fa-share-alt padding-small"></i>
                        分享
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-share" class="sidebar_submenu collapse ">
                    <li>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=../../../../2016/08/05/LTP/" target="popup">
                            <i class="fa fa-facebook-square padding-small"></i>
                            Facebook
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/share?url=../../../../2016/08/05/LTP/" target="popup">
                            <i class="fa fa-google-plus padding-small"></i>
                            Google+
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" target="popup">
                            <i class="fa fa-twitter-square padding-small"></i>
                            Twitter
                        </a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-social">
                        <i class="fa fa-users padding-small"></i>
                        联系
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social" class="sidebar_submenu collapse ">
                    <li>
                        <a href="mailto:peng.li@i-soft.com.cn" title="EMAIL">
                            <i class="fa fa-envelope-square fa-lg padding-small"></i>
                            EMAIL
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/king32783784" title="GitHub">
                            <i class="fa fa-github-square fa-lg padding-small"></i>
                            GitHub
                        </a>
                    </li>
                    <li>
                        <a href="http://king32783784.github.io/feeds/atom.xml" title="RSS">
                            <i class="fa fa-rss-square fa-lg padding-small"></i>
                            RSS
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-pages">
                        <i class="fa fa-folder-open padding-small"></i>
                       站内导航
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-pages" class="sidebar_submenu collapse ">
                    <li>
                        <a href="../../../../pages/opensource.html">
                            <i class="fa fa-file-text padding-small"></i>
                            开源项目
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/links.html">
                            <i class="fa fa-file-text padding-small"></i>
                            常用链接
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/Reference material.html">
                            <i class="fa fa-file-text padding-small"></i>
                            参考资料
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/todo list.html">
                            <i class="fa fa-file-text padding-small"></i>
                            Todo List
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/tools.html">
                            <i class="fa fa-file-text padding-small"></i>
                            工具集
                        </a>
                    </li>
                    <li class="active">
                        <a href="../../../../pages/aboutme.html">
                            <i class="fa fa-file-text padding-small"></i>
                            关于我
                        </a>
                    </li>
                    <li>
                        <a href="../../../../pages/doc.html">
                            <i class="fa fa-file-text padding-small"></i>
                            专题文档
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fa fa-folder-open padding-small"></i>
                        文章分类
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li >
                        <a href="../../../../category/bian-cheng-yu-yan-python.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            编程语言-Python
                            <span class="badge pull-right categorybadge">26</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-selenium.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-Selenium
                            <span class="badge pull-right categorybadge">17</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-autotest.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-Autotest
                            <span class="badge pull-right categorybadge">12</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="../../../../category/zi-dong-hua-ce-shi-ltp.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-LTP
                            <span class="badge pull-right categorybadge">7</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/linux.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Linux
                            <span class="badge pull-right categorybadge">6</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/ce-shi.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            测试
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/leetcode.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            leetcode
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/qi-ta.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            其他
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/xing-neng-ce-shi.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            性能测试
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-robot.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-Robot
                            <span class="badge pull-right categorybadge">4</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/bian-cheng-yu-yan-c.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            编程语言-C
                            <span class="badge pull-right categorybadge">3</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/dockerzhuan-ti.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Docker专题
                            <span class="badge pull-right categorybadge">3</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/python-pyqt.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Python-pyqt
                            <span class="badge pull-right categorybadge">3</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-avocado.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试-Avocado
                            <span class="badge pull-right categorybadge">3</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/suan-fa.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            算法
                            <span class="badge pull-right categorybadge">2</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/unixhuan-jing-bian-cheng.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            unix环境编程
                            <span class="badge pull-right categorybadge">2</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/zi-dong-hua-ce-shi-gong-ju.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            自动化测试工具
                            <span class="badge pull-right categorybadge">2</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/gong-ju.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            工具
                            <span class="badge pull-right categorybadge">1</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/mongodb.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Mongodb
                            <span class="badge pull-right categorybadge">1</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/tong-xin-xiang-guan.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            通信相关
                            <span class="badge pull-right categorybadge">1</span>
                        </a>
                    </li>
                    <li >
                        <a href="../../../../category/web.html">
                            <i class="fa fa-folder-open padding-small"></i>
                            Web
                            <span class="badge pull-right categorybadge">1</span>
                        </a>
                    </li>
                </ul></li>
                
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <a href="#menu-toggle" class="btn btn-default" id="menu-toggle">
            <span id="right-arrow" class="glyphicon glyphicon-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="glyphicon glyphicon-chevron-left" title="minimize sidebar"></span>
        </a>
       <!-- /open/close sidebar -->
       <!--访问统计 -->
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-9">
                <header class="page-header">
                    <h1>
                        <a href="../../../../2016/08/05/LTP/"
                           rel="bookmark"
                           title="Permalink to LTP－kernel-syscalls-accept()">
                            LTP－kernel-syscalls-accept()
                        </a>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2016-08-05T00:00:00+08:00"> 2016-08-05 五</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="../../../../category/zi-dong-hua-ce-shi-ltp.html">自动化测试-LTP</a>
            </span>
            <span class="tags">
                <i class="fa fa-tags padding-small"></i>
                <a href="../../../../tag/ltp.html">LTP</a>            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-9">
                <div class="entry-content">
                    <body><h4 id="acceptyong-li-fen-xi">accept用例分析</h4>
<p>case本身说明：</p>
<div class="highlight"><pre><span></span>Verify that accept() returns the proper errno for various failure cases
</pre></div>
<p>验证accept()是否返回正确的errno.</p>
<p><strong>测试log</strong></p>
<div class="highlight"><pre><span></span>accept01    1  TPASS  :  bad file descriptor successful
accept01    2  TPASS  :  bad file descriptor successful
accept01    3  TPASS  :  invalid socket buffer successful
accept01    4  TPASS  :  invalid salen successful
accept01    5  TPASS  :  invalid salen successful
accept01    6  TPASS  :  no queued connections successful
accept01    7  TPASS  :  UDP accept successful
</pre></div>
<p>~                                              <br/>
测试错误类型包括:</p>
<div class="highlight"><pre><span></span>bad file descriptor、invalid socket buffer、invalid salen、no queued connections、 UDP accept等
</pre></div>
<p><strong>accept函数</strong></p>
<p>accept()</p>
<p>接收一个套接字中已建立的连接</p>
<p><strong>使用格式</strong></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span>
</pre></div>
<p><strong>功能参数描述</strong></p>
<p>accept()系统调用主要用在基于链接的套接字类型，比如SOCK_STREAM和SOCK_SEQPACKET.它提取出所监听套接字的等待连接队列中第一个连接请求，创建一个新的套接字，并返回指向该套接字的文件描述符。新建立的套接字不在监听状态，原来所监听的套接字也不受该系统调用的影响。</p>
<p>备注： 新建立的套接字准备发送send()和接收数据recv().</p>
<p>参数：</p>
<p>sockfd, 利用系统调用socket()建立的套接字描述符，通过bind()绑定到一个本地地址（一般为服务器的套接字），并且通过listen()一直在监听连接。</p>
<p>addr, 指向struct sockaddr的指针，该结构用通讯层服务器对等套接字的地址（一般为客户端地址）填写，返回地址addr的确切格式由套接字的地址类别（比如tcp或udp)决定；若addr为NULL，没有有效地址填写，这种情况下，addrlen也不使用，应该置为NULL；</p>
<p>备注： addr是个指向局部数据结构sockaddr_in的指针，这就是要求接入的信息本地的套接字（地址和指针）</p>
<p>addrlen, 一个值结果参数，调用函数必须初始化为包含addr所指向结构大小的数值，函数返回时包含对等地址（一般为服务器地址）的实际数值；</p>
<p>备注： addrlen 是个局部整型变量， 设置为sizeof(struct sockaddr_in)</p>
<p>如果队列中没有等待的连接，套接字也没有被标记为Non-blocking, accept()会阻塞调用函数知道连接出现；如果套接字被标记为Non-blocking, 队列中也没有等待的连接，accept返回错误EAGAIN或EWOULDBLOCK.</p>
<p>备注： 一般来说，实现时accept()为阻塞函数，当监听socket调用accept()时，它先到自己的receive_buf中查看是否有连接数据包；</p>
<p>若有，把数据拷贝处理啊，删掉接收到的数据包，创建新的socket与客户发来的地址建立链接；</p>
<p>若没有，就阻塞等待；</p>
<p>为了在套接字中有到来的连接时得到通知，可以使用select()或poll().当尝试建立新连接时，系统发送一个可读事件，然后调用accept()为该链接获取套接字。另一种方法是，当套接字中有连接到来时设定套接字发送SIGIO信号。</p>
<p><strong>返回值</strong></p>
<p>成功时，返回非负整数，该整数是接收到套接字的描述符；出错时，返回－１，相应的设定全局变量errno.</p>
<p><strong>错误处理</strong></p>
<p>Linux下，accept()把已等待的网络错误传给新建立的连接，当作是accept()返回的错误。这与其他的BSD实现是不同的。为了可靠运行，应该在accept()之后检测协议已定义的一些网络错误，并把这些错误当作EAGAIN并重试。对于tcp/ip协议来说，主要有：ENETDOWN,EPROTO,ENOPROTOOPT,EHOSTDOWN,ENONET,EHOSTUNREACH,EOPNOTSUPP和ENETUNREACH。</p>
<p><img class="img-responsive" height="280" src="https://d2lm6fxwu08ot6.cloudfront.net/img-thumbs/280h/H01L2BILXC.jpg" width="420"/></p>
<p><strong>accept01.c代码分析</strong></p>
<p>主要函数包括mian、setup、cleanup、setup0、cleanup0、setup1、cleanup1、setup2、setup3</p>
<p>test_case_t结构体</p>
<div class="highlight"><pre><span></span>struct test_caset {         
    int domain;  /*AF_INIT, AF_UNIX,....*/
    int type; /* SOCK_STREAM, SOCK_DGRAM...*/
    int proto; /* protocol number(usually 0 = default) */
    struct sockaddr *sockaddr; /*socket address buffer */
    socklen_t *salen;  /* accept's 3rd argument */
    int retval;   /* syscall return value */
    int experrno;  /* expected errno */
    void (*setup)(void);
    void(*cleanup)(void);
    char *desc;
} 
 tdat[] = {
     {PF_INET, SOCK_STREAM, 0, (struct sockaddr *)&amp;fsin1,
         &amp;sinlen, -1, EBADF, setup0, cleanup0,
         "bad file descriptor"},   //无效的文件描述符
      PF_INET, SOCK_STREAM, 0, (struct sockaddr *)&amp;fsin1,
        &amp;sinlen, -1, ENOTSOCK, setup0, cleanup0,
        "bad file descriptor"}, { //无效的文件描述符
      PF_INET, SOCK_STREAM, 0, (struct sockaddr *)3,
        &amp;sinlen, -1, EINVAL, setup1, cleanup1,
        "invalid socket buffer"}, {  //无效套接字缓存区
      PF_INET, SOCK_STREAM, 0, (struct sockaddr *)&amp;fsin1,
        (socklen_t *) 1, -1, EINVAL, setup1, cleanup1,
        "invalid salen"}, {   //无效的salen
      PF_INET, SOCK_STREAM, 0, (struct sockaddr *)&amp;fsin1,
        &amp;sinlen, -1, EINVAL, setup2, cleanup1,
        "invalid salen"}, {
      PF_INET, SOCK_STREAM, 0, (struct sockaddr *)&amp;fsin1,
        &amp;sinlen, -1, EINVAL, setup3, cleanup1,
        "no queued connections"}, {  //队列中没有等待的连接
      PF_INET, SOCK_DGRAM, 0, (struct sockaddr *)&amp;fsin1,
        &amp;sinlen, -1, EOPNOTSUPP, setup1, cleanup1,
        "UDP accept"},};
int TST_TOTAL = sizeof(tdat) / sizeof(tdat[0]); /*通过数组的长度，计算测试用例数量*/
</pre></div>
<p>先定义测试case需要的结构体，然后进行了<a href="https://king32783784.github.io/2011/07/11/C">结构体初始化</a>，定义了7种错误类型，对应7个测试case，和测试log是对应的。
顺便看一下 SOCK_STREAM和SOCK_DGRAM的区别：
    sock_stream   是有保障的（即能保证数据正确传送到对方）面向连接的SOCKET，多用于资料（如文件）传送。
    sock_dgram   是无保障的面向消息的socket　，　主要用于在网络上发广播信息。
    SOCK_STREAM是基于TCP的，数据传输比较有保障。SOCK_DGRAM是基于UDP的，专门用于局域网，基于广播
    SOCK_STREAM 是数据流,一般是tcp/ip协议的编程,SOCK_DGRAM分是数据抱,是udp协议网络编程</p>
<p>再看说一下AF_INET和PF_INET的差别：     </p>
<p>在Unix/Linux系统中，在不同的版本中这两者有微小差别.对于BSD,是AF,对于POSIX是PF.理论上建立socket时是指定协议，应该用PF_xxxx，设置地址时应该用AF_xxxx</p>
<p>分别看一下这几个错误码</p>
<ul>
<li>
<p>EBADF:
当作为参数的套接字不是一个有效的文件描述符(在Linux下用文件描述符来表示设备文件和普通文件。文件描述符是一个整型的数据，所有对文件的操作都通过文件描述符实现。文件描述符是文件系统中链接用户空间和内核空间的枢纽)时，抛出这个错误码。无效的文件描述符是什么意思呢？就是fd已经close的，或者本身就不是个有效的socket的fd。</p>
</li>
<li>
<p>ENOTSOCK:
在非socket上执行socket操作。</p>
</li>
<li>
<p>EINVAL：
无效参数。提供的参数非法。有时也会与socket的当前状态相关，如一个socket并没有进入listening状态，此时调用accept，就会产生EINVAL错误。</p>
</li>
<li>
<p>EOPNOTSUPP:
不支持的操作。
引用对象的类型不支持尝试的操作。通常，这发生在套接字描述符不支持此操作，例如，试着接受数据报套接字上的连接的套接字。</p>
</li>
</ul>
<p>接下来看几个辅助函数。</p>
<p>1.setup函数</p>
<div class="highlight"><pre><span></span>static void setup(void)
{
     TEST_PAUSE;
     /*初始化本地 sockaddr*/
     sin0.sin_family = AF_INET;  //绑定本地地址或连接远程地址时需要初始化sockaddr_in结构，其中指定address family时一般设置为AF_INET，即使用IP
     sin0.sin_port = 0;
     sin0.sin_addr.s_addr = INADDR_ANY; //指定地址为0.0.0.0的地址
}
</pre></div>
<p>TEST_PAUSE是一个<a href="https://king32783784.github.io/2011/08/15/C">宏定义</a>，代表usc_global_setup_hook()函数。作用是当设置了暂停标志后，暂停<a href="https://king32783784.github.io/2009/10/12/UNIX">SIGUSR1</a>，当新的信号来时，再继续。下面是usc_global_setup_hook函数实现：</p>
<div class="highlight"><pre><span></span><span class="cp">#define TEST_PAUSE usc_global_setup_hook();</span>
<span class="kt">int</span> <span class="nf">usc_global_setup_hook</span><span class="p">()</span>

<span class="kt">int</span> <span class="n">usc_global_setup_hook</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef UCLINUX</span>
   <span class="cm">/*定义temp变量存储信号旧信号的动作，中断后恢复*/</span>
   <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">_TMP_FUNC</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
   <span class="cm">/*中断等待sigusr1.*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">STD_PAUSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_TMP_FUNC</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">singnal</span><span class="p">(</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">STD_go</span><span class="p">);</span>
        <span class="n">pause</span><span class="p">()</span>
        <span class="n">signal</span><span class="p">(</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">_TMP_FUNC</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">STD_TP_sbrk</span><span class="p">)</span> <span class="o">||</span> <span class="n">STD_LP_sbrk</span><span class="p">)</span>
        <span class="n">STD_start_break</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/*获取原始sbreak大小*/</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">STD_TP_sbrk</span><span class="p">){</span>
        <span class="n">sbrk</span><span class="p">(</span><span class="n">STD_TP_sbrk</span><span class="p">)</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Debug</span><span class="p">)</span>
            <span class="n">print</span><span class="p">(</span><span class="s">"after sbrk(%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">STD_TP_sbrk</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p _="
" _tdat_testno_.experr="(tdat[testno].experr" if="if">2.setup0函数case1测试前设置
    static void setup0(void)</p>
<p>3.setup2</p>
<div class="highlight"><pre><span></span>static void setup2(void)
{
    setup1(); //调用setup1()获取套接字s
    sinlen = 1;  //s置为无效
}
</pre></div>
<p>4.setup3</p>
<div class="highlight"><pre><span></span>static void setup3(void)
{
    int one = 1;

    setup1();
    SAFE_IOCTL(cleanup, s, FIONBIO, &amp;one);
}
</pre></div>
<p>SAFE_IOCTL</p>
<div class="highlight"><pre><span></span><span class="p">#</span><span class="nn">define</span> <span class="nt">SAFE_IOCTL</span><span class="o">(</span><span class="nt">cleanup_fn</span><span class="o">,</span> <span class="nt">fd</span><span class="o">,</span> <span class="nt">request</span><span class="o">,</span> <span class="o">...)</span>             <span class="err">\</span>
    <span class="o">(</span><span class="p">{</span><span class="err">int</span> <span class="err">ret</span> <span class="err">=</span> <span class="err">ioctl(fd,</span> <span class="err">request,</span> <span class="err">__VA_ARGS__)</span><span class="p">;</span>         <span class="err">\</span>                                                            
    <span class="err">ret</span> <span class="err">&lt;</span> <span class="err">0</span> <span class="err">?</span>                                          <span class="err">\</span>                                                            
    <span class="err">tst_brkm(TBROK</span> <span class="err">|</span> <span class="err">TERRNO,</span> <span class="err">cleanup_fn,</span>              <span class="err">\</span>                                                            
    <span class="err">"ioctl(%i,%s,...)</span> <span class="err">failed",</span> <span class="err">fd,</span> <span class="err">#request)</span> <span class="err">\</span>                                                            
    <span class="n">safe_</span><span class="p">:</span> <span class="n">ret</span><span class="p">;}</span><span class="o">)</span>
</pre></div>
<p>6.cleanup、cleanup0, cleanup1</p>
<div class="highlight"><pre><span></span>static void cleanup(void)
{
}

static void cleanup0(void)
{
    s = -1;
}

static void cleanup1(void)
{
    (void)close(s);
    s = -1;
}
</pre></div>
<p>重新设置s = -1</p>
<p>OK,现在看一下main函数。</p>
<div class="highlight"><pre><span></span>int main(int ac, char *av[])
{
    int lc;

    tst_parse_opts(ac, av, NULL, NULL);  //ltp参数解析函数

    setup();

    for (lc = 0; TEST_LOOPING(lc); ++lc){
        test_count = 0;
        for (testno = 0; testno &lt; TST_TOTAL; ++testno){
            tdat[testno].setup();

            TEST(accept(s, tdat[testno].sockaddr,
                tdat[testno].salen));
            if (TEST_RETURN &gt; 0)
                TEST_RETURN = 0;
            if (TEST_RETURN != tdat[testno].retval ||
                (TEST_RETURN &lt; 0 &amp;&amp;
                 TEST_ERRNO != tdat[testno].experrno)){
                  "%ld(expected %d), errno %d (expected"
                  "%d)", tdat[testno].desc,
                  TEST_RETURN, tdat[testno].desc,
                  TEST_ERRNO, tdat[testno].experrno);
            } else {
                tst_resm(TPASS, "%s successful",
                    tdat[testno].desc);
            }
            tdat[testno].cleanup();
        }

    }
    cleanup();
    tst_exit();
}
</pre></div>
<p>先看一下tst_parse_opts()函数</p>
<div class="highlight"><pre><span></span>void tst_parse_opts(int argc, char *argv[], const option_t *user_optarg,
                    void (*user_help)(void))
{
    const char *msg;

    msg = parse_opts(argc, argv, user_optarg, user_help); //parse_opts是参数解析函数，后面文章再进行介绍

    if(msg)
        tst_brkm(TBROK, NULL, "OPTION  PARSING ERROR - %s ", msg);
}
</pre></div>
<p>接下来调用setup，准备测试环境，初始化本地IP地址。然后是一个嵌套的两层循环，第一次是测试次数的遍历，通过TEST_LOOPING实现。
TEST_LOOPING是int usc_test_looping(int counter)函数，该函数后面的文章再进行解释。tst_count初始化为0。</p>
<p>第二层循环是遍历case数组。tdat[testno].setup()，调用对应setup准备case的特殊设置。</p>
<p>TEST启动测试，</p>
<div class="highlight"><pre><span></span>#define TEST(SCALL) \
    do { \
    errno = 0; \
    TEST_RETURN = SCALL; \
    TEST_ERRNO = errno; \
}
</pre></div>
<p>然后将tdat中的对应参数，分别执行accept函数，如果预期的返回值不符或则返回值小于0且和预期的错误类型不匹配，则调用tst_resm()，进行出错处理。tst_resm将在后面进行分析。如果符合预期，则打印TPASS，然后调用tdat[testno].clearnup()分别清理环境。</p>
<p>最后调用cleanup()清理，tst_exit()退出，tst_exit()在单独分析ltp测试框架时分析。</p>
<p>到此，我们就清楚accept测试的内容了。</p>
<p><img class="img-responsive" height="280" src="https://d2lm6fxwu08ot6.cloudfront.net/img-thumbs/280h/H01L2BILXC.jpg" width="420"/></p></body>
                </div>
                <footer class="text-right">
                    <p>by 李鹏</p>
                </footer>
  <!-- css -->
  <style type="text/css">
      .center {
          text-align: center;
      }
      .hidden {
          display: none;
      }
    .donate_bar a.btn_donate{
      display: inline-block;
      width: 80px;
      height:80px;
      background: url("http://7xsl28.com1.z0.glb.clouddn.com/btn_reward.gif") no-repeat;
      _background: url("http://7xsl28.com1.z0.glb.clouddn.com/btn_reward.gif") no-repeat;

      <!-- http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif
           因为本 hexo 生成的博客所用的 theme 的 a:hover 带动画效果，
         为了在让打赏按钮显示效果正常 而 添加了以下几行 css，
         嵌入其它博客时不一定要它们。 -->
      -webkit-transition: background 0s;
      -moz-transition: background 0s;
      -o-transition: background 0s;
      -ms-transition: background 0s;
      transition: background 0s;
      <!-- /让打赏按钮的效果显示正常 而 添加的几行 css 到此结束 -->
    }

    .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
    .donate_bar .donate_txt {
      display: block;
      color: #9d9d9d;
      font: 14px/2 "Microsoft Yahei";
    }
    .bold{ font-weight: bold; }
  </style>
  <!-- /css -->

    <!-- Donate Module -->
    <div id="donate_module">

  <!-- btn_donate & tips -->
  <div id="donate_board" class="donate_bar center">
      <br>
      ------------------------------------------------------------------------------------------------------------------------------
      <br>
    <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    <span class="donate_txt">
      <Enjoy it ? Donate me !  欣赏此文？求鼓励，求支持！>
    </span>
      
    
  </div>
  <!-- /btn_donate & tips -->

  <!-- donate guide -->
    
  <div id="donate_guide" class="donate_bar center hidden">
        <br>
      ------------------------------------------------------------------------------------------------------------------------------
      <br>

    <a href="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/wechart.png?raw=true" title="用微信扫一扫哦~" class="fancybox" rel="article0">
      <img src="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/wechart.png?raw=true" title="微信打赏 Colin" height="320px" width="auto"/>
    </a>
        
        &nbsp;&nbsp;
   <a href="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/alipay.png?raw=true" title="用支付宝扫一扫即可~" class="fancybox" rel="article0">
      <img src="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/alipay.png?raw=true" title="支付宝打赏 Colin" height="320px" width="auto"/>
    </a>

    <span class="donate_txt">
      <Enjoy it ? Donate me !  欣赏此文？求鼓励，求支持！>
    </span>

  </div>
  <!-- /donate guide -->

  <!-- donate script -->
  <script type="text/javascript">
    document.getElementById('btn_donate').onclick = function() {
      $('#donate_board').addClass('hidden');
      $('#donate_guide').removeClass('hidden');
    }

    function donate_on_web(){
      $('#donate').submit();
        }

    var original_window_onload = window.onload;
        window.onload = function () {
            if (original_window_onload) {
                original_window_onload();
            }
            document.getElementById('donate_board_wdg').className = 'hidden';
    }
  </script>
  <!-- /donate script -->
</div>
<!-- /Donate Module -->
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2127927"></script>
<!-- UY END -->
            </div>
    <div id="scrollspy">
        <div class="col-lg-3 nav nav-stacked hidden-xs hidden-sm" data-spy="affix" data-offset-top="135">
            <div id="toc"><ul><li><a class="toc-href" href="#" title="LTP－kernel-syscalls-accept()">LTP－kernel-syscalls-accept()</a><ul><li><a class="toc-href" href="#acceptyong-li-fen-xi" title="accept用例分析">accept用例分析</a></li></ul></li></ul></div>
        </div>
    </div>
        </div>
    </article>
</section>

<!--"-->
<footer>
    <hr>
    <div class="row">
        <div class="col-lg-9 text-center">
            <p><small>
                <a href="http://www.reliablecounter.com" target="_blank"><img src="http://www.reliablecounter.com/count.php?page=https://king32783784.github.io/&digit=style/plain/6/&reloads=0" alt="" title="" border="0"></a><br /><a href="http://www.fabbly.com" target="_blank" style="font-family: Geneva, Arial; font-size: 9px; color: #330010; text-decoration: none;"></a>
                Copyright</a>  </a>
                <!--&middot;-->                    &copy;2009 李鹏
            </small></p>
        </div>
    </div>
</footer>
            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->
    <!-- jQuery Version 1.11.2 -->
    <script src="../../../../theme/js/jquery-1.11.2.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="../../../../theme/js/bootstrap.min.js"></script>
    <!-- twitchy Script -->
    <script src="../../../../theme/js/pelican_twitchy.min.js"></script>
    <!-- Begin Cookie Consent https://silktide.com/tools/cookie-consent/ -->
    <script>
        window.cookieconsent_options = {
            message: "This site uses Cookies. If you continue without changing your settings, it is assumed that you are happy to receive all cookies from this website.",
            learnMore: "More info",
            link: null,
            dismiss: "Got it!",
            theme: "../../../../theme/css/cookieconsent/dark-floating.css",
        };
    </script>
    <script src="../../../../theme/js/cookieconsent.min.js"></script>
    <!-- End Cookie Consent -->

</body>
</html>